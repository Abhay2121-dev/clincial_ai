name: Weekly Clinical Trials Update

on:
  # Run every Sunday at midnight UTC
  schedule:
    - cron: '0 0 * * 0'
  
  # Allow manual trigger for testing
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-trials-database:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 1
      
      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          pip install langchain-community
          pip install langchain-huggingface
          pip install langchain-core
          pip install faiss-cpu
          pip install sentence-transformers
          pip install pytest
      
      - name: Verify Installation
        run: |
          echo "=== Python Environment ==="
          python --version
          echo ""
          echo "=== Installed Packages ==="
          pip list | grep -E "(langchain|faiss|sentence|pytest|requests)"
      
      - name: Run Unit Tests
        run: |
          echo "=== Running Unit Tests ==="
          pytest test_etl.py -v --tb=short
        continue-on-error: false
      
      - name: Run ETL Pipeline
        run: |
          echo "=== Starting ETL Pipeline ==="
          python etl.py
      
      - name: Verify Database Creation
        run: |
          if [ -d "faiss_production_index" ]; then
            echo "‚úÖ Database folder created successfully"
            echo "üìÇ Contents:"
            ls -lh faiss_production_index/
          else
            echo "‚ùå Database folder not found!"
            exit 1
          fi
      
      - name: Check Database Updates
        id: check_changes
        run: |
          if [ -d "faiss_production_index" ]; then
            echo "Checking for changes in database..."
            git add faiss_production_index
            
            if git diff --cached --quiet; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è  No changes detected"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Changes detected - will commit"
              echo "üìä Changed files:"
              git diff --cached --name-only
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Database folder not found"
          fi
      
      - name: Commit and Push Changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.name "GitHub Actions Bot"
          git config --local user.email "actions@github.com"
          
          COMMIT_MSG="üîÑ Weekly database update - $(date +'%Y-%m-%d %H:%M UTC')"
          git commit -m "$COMMIT_MSG"
          
          echo "üì§ Pushing changes to repository..."
          git push
          
          echo "‚úÖ Changes successfully pushed"
      
      - name: Workflow Summary
        if: always()
        run: |
          echo "=== WORKFLOW SUMMARY ==="
          echo "Date: $(date)"
          echo ""
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Workflow Status: SUCCESS"
          else
            echo "‚ùå Workflow Status: FAILED"
          fi
          
          echo ""
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "üìä Database Changes: YES - Changes committed and pushed"
          else
            echo "üìä Database Changes: NO - No updates needed"
          fi
          
          echo ""
          echo "=== Next Steps ==="
          echo "- Check the 'faiss_production_index' folder in your repo"
          echo "- Review the test results above"
          echo "- Next scheduled run: Next Sunday at 00:00 UTC"
